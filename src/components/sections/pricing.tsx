"use client";

import { useState, useCallback, useMemo } from "react";
import { useTranslations } from "next-intl";
import { Link } from "@/i18n/navigation";
import { Section, SectionHeader } from "@/components/ui/section";
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Reveal } from "@/components/ui/reveal";

type Duration = "monthly" | "sixMonth" | "annual";

interface PriceData {
  total: number;
  monthly: number;
  savings: number | null;
}

const PRICES: Record<Duration, PriceData> = {
  monthly: { total: 4, monthly: 4, savings: null },
  sixMonth: { total: 20, monthly: 3.33, savings: 17 },
  annual: { total: 35, monthly: 2.92, savings: 27 },
};

function formatPrice(amount: number): string {
  return `$${amount.toFixed(2)}`;
}

const freeFeatureKeys = [
  "servers",
  "data",
  "protocols",
  "devices",
  "noLogs",
] as const;

const plusFeatureKeys = [
  "everything",
  "adBlocker",
  "categoryFilter",
  "customBlocklist",
  "devices",
  "support",
  "smartVpn",
] as const;

interface DurationSelectorProps {
  selected: Duration;
  onSelect: (duration: Duration) => void;
  t: ReturnType<typeof useTranslations>;
}

function DurationSelector({ selected, onSelect, t }: DurationSelectorProps) {
  const durations = useMemo<Duration[]>(() => ["monthly", "sixMonth", "annual"], []);
  const selectedIndex = durations.indexOf(selected);

  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent, currentIndex: number) => {
      let newIndex = currentIndex;

      if (e.key === "ArrowRight" || e.key === "ArrowDown") {
        e.preventDefault();
        newIndex = (currentIndex + 1) % durations.length;
      } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
        e.preventDefault();
        newIndex = (currentIndex - 1 + durations.length) % durations.length;
      } else if (e.key === "Home") {
        e.preventDefault();
        newIndex = 0;
      } else if (e.key === "End") {
        e.preventDefault();
        newIndex = durations.length - 1;
      }

      if (newIndex !== currentIndex) {
        onSelect(durations[newIndex]);
      }
    },
    [durations, onSelect]
  );

  return (
    <div
      role="tablist"
      aria-label={t("durationSelector")}
      className="relative flex bg-overlay/5 rounded-full p-1"
    >
      {/* Sliding pill background */}
      <span
        className="absolute top-1 bottom-1 bg-accent-teal rounded-full transition-all duration-200 ease-out"
        style={{
          insetInlineStart: `calc(${selectedIndex * (100 / 3)}% + 4px)`,
          width: `calc(${100 / 3}% - 8px)`,
        }}
      />
      {durations.map((duration, index) => {
        const isSelected = selected === duration;
        const isAnnual = duration === "annual";

        return (
          <button
            key={duration}
            role="tab"
            aria-selected={isSelected}
            tabIndex={isSelected ? 0 : -1}
            onClick={() => onSelect(duration)}
            onKeyDown={(e) => handleKeyDown(e, index)}
            className={`
              relative flex-1 px-4 py-3 text-sm font-medium rounded-full z-10
              transition-colors duration-200 focus-visible:outline-none
              focus-visible:ring-2 focus-visible:ring-accent-teal focus-visible:ring-offset-2
              focus-visible:ring-offset-bg-primary
              ${
                isSelected
                  ? "text-bg-primary"
                  : "text-text-muted hover:text-text-primary"
              }
            `}
          >
            <span className="relative z-10 flex items-center justify-center gap-1.5">
              {t(`durations.${duration}`)}
              {isAnnual && (
                <span
                  className={`
                  hidden sm:inline text-[10px] uppercase tracking-wider font-bold
                  px-1.5 py-0.5 rounded-full
                  ${
                    isSelected
                      ? "bg-bg-primary/20 text-bg-primary"
                      : "bg-accent-teal/15 text-accent-teal"
                  }
                `}
                >
                  {t("bestValue")}
                </span>
              )}
            </span>
          </button>
        );
      })}
    </div>
  );
}

interface PriceDisplayProps {
  duration: Duration;
  t: ReturnType<typeof useTranslations>;
}

function PriceDisplay({ duration, t }: PriceDisplayProps) {
  const priceData = PRICES[duration];
  const monthlyBase = PRICES.monthly.monthly;

  return (
    <div className="flex flex-col items-center gap-2 transition-opacity duration-150">
      {/* Strikethrough original price (for multi-month plans) */}
      {priceData.savings && (
        <span className="text-lg text-text-muted line-through">
          {formatPrice(monthlyBase)}/mo
        </span>
      )}

      {/* Main price */}
      <div className="flex items-baseline gap-1">
        <span className="font-display text-5xl md:text-6xl font-bold text-text-primary">
          {formatPrice(priceData.monthly)}
        </span>
        <span className="text-xl text-text-muted">/mo</span>
      </div>

      {/* Total billing info */}
      <p className="text-text-muted text-sm">
        {duration === "monthly" ? (
          t("billedMonthly")
        ) : (
          <>
            {t("billed")} {formatPrice(priceData.total)}{" "}
            {duration === "sixMonth" ? t("every6Months") : t("perYear")}
          </>
        )}
      </p>

      {/* Savings badge */}
      {priceData.savings && (
        <Badge variant="teal" className="mt-1">
          {t("save")} {priceData.savings}%
        </Badge>
      )}
    </div>
  );
}

function CheckIcon({ className }: { className: string }) {
  return (
    <svg
      className={`w-4 h-4 flex-shrink-0 ${className}`}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="m4.5 12.75 6 6 9-13.5"
      />
    </svg>
  );
}

export function Pricing() {
  const t = useTranslations("pricing");
  const [selectedDuration, setSelectedDuration] = useState<Duration>("annual");

  return (
    <Section id="pricing" className="bg-bg-secondary/30">
      <SectionHeader title={t("title")} subtitle={t("subtitle")} />

      <Reveal className="max-w-4xl mx-auto">
        <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
          {/* Free Card */}
          <div className="order-last md:order-first md:col-span-2">
            <Card padding="lg" className="h-full">
              <div className="text-center mb-6">
                <Badge variant="default" className="mb-4">
                  {t("freeBadge")}
                </Badge>
                <h3 className="font-display text-2xl font-semibold text-text-primary mb-2">
                  {t("freeTitle")}
                </h3>
                <p className="text-text-muted text-sm">
                  {t("freeSubtitle")}
                </p>
              </div>

              {/* Free Price */}
              <div className="text-center mb-8">
                <div className="flex items-baseline justify-center gap-1">
                  <span className="font-display text-5xl md:text-6xl font-bold text-text-primary">
                    {t("freePrice")}
                  </span>
                  <span className="text-xl text-text-muted">
                    /{t("freePeriod")}
                  </span>
                </div>
              </div>

              {/* Free Features */}
              <ul className="space-y-3 mb-8">
                {freeFeatureKeys.map((feature) => (
                  <li
                    key={feature}
                    className="flex items-center gap-2 text-text-muted text-sm"
                  >
                    <CheckIcon className="text-text-muted" />
                    {t(`freeFeatures.${feature}`)}
                  </li>
                ))}
              </ul>

              {/* Free CTA */}
              <Button
                variant="outline"
                className="w-full"
                size="lg"
                href="/downloads"
              >
                {t("freeCta")}
              </Button>
            </Card>
          </div>

          {/* Plus Card */}
          <div className="order-first md:order-last md:col-span-3">
            <Card
              padding="lg"
              className="h-full border-accent-teal/30 bg-gradient-to-b from-accent-teal/5 to-transparent"
            >
              <div className="text-center mb-6">
                <Badge variant="teal" className="mb-4">
                  {t("plusBadge")}
                </Badge>
                <h3 className="font-display text-2xl font-semibold text-text-primary mb-2">
                  {t("plusTitle")}
                </h3>
                <p className="text-text-muted text-sm">
                  {t("plusSubtitle")}
                </p>
              </div>

              {/* Duration Selector */}
              <div className="mb-8">
                <DurationSelector
                  selected={selectedDuration}
                  onSelect={setSelectedDuration}
                  t={t}
                />
              </div>

              {/* Price Display */}
              <div className="text-center mb-8 min-h-[140px] flex items-center justify-center">
                <PriceDisplay duration={selectedDuration} t={t} />
              </div>

              {/* Plus Features */}
              <ul className="space-y-3 mb-8">
                {plusFeatureKeys.map((feature) => (
                  <li
                    key={feature}
                    className="flex items-center gap-2 text-text-muted text-sm"
                  >
                    <CheckIcon className="text-accent-teal" />
                    {t(`plusFeatures.${feature}`)}
                    {feature === "smartVpn" && (
                      <Badge
                        variant="teal"
                        className="ms-1.5 text-[10px] px-1.5 py-0.5"
                      >
                        {t("comingSoon")}
                      </Badge>
                    )}
                  </li>
                ))}
              </ul>

              {/* Plus CTA */}
              <Button
                variant="primary"
                className="w-full"
                size="lg"
                href="https://t.me/dopplercreatebot"
                external
              >
                {t("plusCta")}
              </Button>

              {/* Trial note */}
              <p className="text-center text-text-muted text-xs mt-4">
                {t("trialNote")}
              </p>

              {/* Platform note */}
              <p className="text-center text-text-muted/70 text-xs mt-3">
                {t("platformNote")}{" "}
                <Link
                  href="/guide/subscription"
                  className="text-accent-teal hover:underline"
                >
                  {t("platformLink")}
                </Link>
              </p>
            </Card>
          </div>
        </div>
      </Reveal>

      {/* Money-back guarantee */}
      <Reveal className="text-center mt-8" delay={100}>
        <p className="text-text-muted text-sm">
          <svg
            className="inline-block w-5 h-5 me-2 text-accent-teal"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z"
            />
          </svg>
          {t("guarantee")}
        </p>
      </Reveal>
    </Section>
  );
}
